---
title: "Attrition Predictor Analysis"

output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: ["github","linkedin"]
    source_code: embed
---

```{r setup, include=FALSE}
library(flexdashboard)
library(knitr)
library(DT)
library(rpivotTable)
library(ggplot2)
library(plotly)
library(dplyr)
library(openintro)
library(highcharter)
library(ggvis)
library(broom)
```


```{r, message=FALSE}
#"data" has categorical data converted to numerical
# "data2" has a mixed data types
data <- read.csv("~/Documents/Projects/SMU/rProjects/CaseStudy_02/CaseStudy_02/NumData.csv")
data2 <- read.csv("~/Documents/Projects/SMU/rProjects/CaseStudy_02/CaseStudy_02/CaseStudy2-data.csv")
#View(data)
#str(data)
```

```{r echo=FALSE}
# embed all Rmd and csv files
xfun::embed_files(list.files('.', '[.](Rmd|csv)$'))
```

```{r}
mycolors <- c("blue", "#FFC125", "darkgreen", "darkorange", "darkblue")
```
About Report
========================================
<div align='center', padding: 50px>
<br>
<h1 style="font-size:70px;"><b>Attrition Predictor Analysis</b></h1>
<hr>
<br>
<br>
<br><img class="one" src="logo2.png" width="250" height="250"><br>
<br>
<br>
  <h1>Project By:</h1>
  <br><h2>Heindel Adu, Stephen Johnson, Ross Fu, Anthony Yeung </h2> </br>
  <h3>Classification: <br> <b> CONFIDENTIAL REPORT! </b><br></h3>
</div>

Int Data Viz
=====================================
Row
-------------------------------------
### Attrition Count

```{r}
valueBox(paste("Attrition"),
         color = "darkblue")
#unique.(data$Attrition)

#data %>%
#  summarise(Attrition = n())
```

### Number of Employee Data Reviewed

```{r}

valueBox(length(data$Attrition),
         icon = "fa-users")
```

### **Monthly Income**
```{r}
gauge(round(min(data$MonthlyIncome),
            digits = 2),
            min = 0,
            max = 25000,
      label = "Min Monthly Income",
            gaugeSectors(success = c(15000, 25000),
                         warning = c(5000,15000),
                         danger = c(0, 5000),
                         colors = c("green", "yellow", "red")))
```

```{r}
gauge(round(mean(data$MonthlyIncome),
            digits = 2),
            min = 0,
            max = 25000,
       label = "Avg Monthly Income",
            gaugeSectors(success = c(15000, 25000),
                         warning = c(5000,15000),
                         danger = c(0, 5000),
                         colors = c("green", "yellow", "red")))

```

```{r}
gauge(round(max(data$MonthlyIncome),
            digits = 2),
            min = 0,
            max = 25000,
       label = "Max Monthly Income",
            gaugeSectors(success = c(15000, 25000),
                         warning = c(5000,15000),
                         danger = c(0, 5000),
                         colors = c("green", "yellow", "red")))
```

### Yes on Attrition

```{r, Yes}
valueBox(sum(data$Attrition == "Yes"),
         icon = 'fa-user-o')

```


### No on Attrition

```{r, No}
valueBox(sum(data$Attrition == "No"),
         icon = 'fa-user')
```

Row
-------------------------------------------------
### **Plotly Bar Plot **
```{r}
#summary(data2$Attrition)
#str(data2$Attrition)
#p0 <- ggplot2::data2 %>% sum(JobRole, Attrition) %>%
#  plot_ly(x = ~JobRole, y = ~n, color = ~Attrition)
p1 <- data2 %>%
  group_by(JobRole) %>%
  summarise(count = n()) %>%
  plot_ly(x = ~JobRole,
          y = ~count,
          color = 'blue',
          type = 'bar') %>%
  layout(xaxis = list(title = "Job Role"),
    yaxis = list(title = 'Count'))
p1
#names(data2)
```


### **Plotly Box Plot of Job Role & Income**
```{r}
data2 %>%
         group_by(JobRole) %>%
         plot_ly(y = ~JobRole, x = ~MonthlyIncome, type = "box", boxpoints = "outliers", color = ~JobRole, jitter = 0.3, pointpos = 0, orientation = "h")
```



Scatter Plots
=====================================
Row
-------------------------------------
### **Monthly Income v Age**
```{r}
j <- loess(MonthlyIncome ~ Age, data = data2)
p2 <- plot_ly(data = data2, x = ~Age,
          y = ~MonthlyIncome,
          color = as.factor(data2$Attrition),
          type = 'scatter', alpha = 0.9) %>%
  add_lines(y= ~fitted(loess(data2$MonthlyIncome ~ data2$Age)),
            line = list(color = 'rgba(7,164,181,1)'),
            name = "Loess Smoother") %>%
  add_ribbons(data = augment(j),
              ymin = ~.fitted - 1.96 * .se.fit,
              ymax = ~.fitted + 1.96 * .se.fit,
              line = list(color = 'rgba(7, 164, 181, 0.05)'),
              fillcolor = 'rgba(7, 164, 181, 0.2)',
              name = "Standard Error") %>%
    layout(xaxis = list(title = "Age"),
    yaxis = list(title = 'Monthly Income'))

p2
```

### **Monthly Income v  Time in C. Role**
```{r}
l <- loess(MonthlyIncome ~ YearsInCurrentRole, data = data2)
p3 <- plot_ly(data = data2, x = ~YearsInCurrentRole,
          y = ~MonthlyIncome,
          color = as.factor(data2$Attrition),
          type = 'scatter', alpha = 0.9) %>%
  add_lines(y= ~fitted(loess(data2$MonthlyIncome ~ data2$YearsInCurrentRole)),
            line = list(color = 'rgba(7,164,181,1)'),
            name = "Loess Smoother") %>%
  add_ribbons(data = augment(l),
              ymin = ~.fitted - 1.96 * .se.fit,
              ymax = ~.fitted + 1.96 * .se.fit,
              line = list(color = 'rgba(7, 164, 181, 0.05)'),
              fillcolor = 'rgba(7, 164, 181, 0.2)',
              name = "Standard Error") %>%
    layout(xaxis = list(title = "Years In Current Role"),
    yaxis = list(title = 'Monthly Income'))

p3
```

### **Monthly Income v Time At Company **
```{r}
k <- loess(MonthlyIncome ~ YearsAtCompany, data = data2)
p5 <- plot_ly(data = data2, x = ~YearsAtCompany,
          y = ~MonthlyIncome,
          color = as.factor(data2$Attrition),
          type = 'scatter', alpha = 0.9) %>%
  add_lines(y= ~fitted(loess(data2$MonthlyIncome ~ data2$YearsAtCompany)),
            line = list(color = 'rgba(7,164,181,1)'),
            name = "Loess Smoother") %>%
  add_ribbons(data = augment(k),
              ymin = ~.fitted - 1.96 * .se.fit,
              ymax = ~.fitted + 1.96 * .se.fit,
              line = list(color = 'rgba(7, 164, 181, 0.05)'),
              fillcolor = 'rgba(7, 164, 181, 0.2)',
              name = "Standard Error") %>%
    layout(xaxis = list(title = "Years At Company"),
    yaxis = list(title = 'Monthly Income'))

p5
```

Row
---------------------------------------------
<div align="left", padding : 10px;>
<p padding:15px;><h3><b> Comparison of Monthly Income with other variables.</b></h3></p>
<ol> 
  <br><li> Age </li> </br>
  <br><li> Time in Current Role </li> </br>
  <br><li> Time with Company </li> </br>
</ol>
</div>
```{r}
### **Box Plot of Top JobRole**
#data2 %>%
#         group_by(JobRole) %>%
#         ggvis(~JobRole, ~MonthlyIncome, fill = ~JobRole) %>%
#         layer_boxplots()
```


Data Table
========================================

```{r}
datatable(data2,
          caption = "Attrition Data",
          rownames = TRUE,
          filter = "top",
          options = list(pageLength = 25))
```

Pivot Table - Mixed
=========================================

```{r}
rpivotTable(data2,
            aggregatorName = "Count",
            cols= "Attrition",
            rows = "JobRole",
            rendererName = "Heatmap")
```



R Forest
========================================

```{r}
#View(data)
#names(data)
# Partition Data
#str(data$AttritionN)
data$AttritionN <- as.factor(data$AttritionN)
rfdata <-data[1:34]
#names(rfdata)
# Data Partition
set.seed(111)
ind <- sample(2, nrow(rfdata), replace = TRUE, prob = c(0.7, 0.3))
training <- rfdata[ind==1,]
testing <- rfdata[ind==2,]


# Random Forest
library(randomForest)
set.seed(222)
rf <- randomForest(AttritionN~., data=training,
                   ntree = 300,
                   mtry = 8,
                   importance = TRUE,
                   proximity = TRUE)
```

Row
----------------------------------------
### **RF Parameters **
```{r}
print(rf)
```

### **RF Attributes **
```{r}
attributes(rf)
```

Row
--------------------------------
### **Error Rate **
```{r}
# Error rate of Random Forest
plot(rf)
```

### **# Nodes for the Trees **
```{r}
# No. of nodes for the trees
hist(treesize(rf),
     main = "No. of Nodes for the Trees",
     col = "lightblue")
```

Matrix
======================================

Row 
--------------------------------------

### **Training C-Matrix **
```{r}
# Prediction & Confusion Matrix - training data
library(caret)
p9 <- predict(rf, training)
confusionMatrix(p9, training$AttritionN)
```

### **Testing C-Matrix **
```{r}
# # Prediction & Confusion Matrix - testing data
p10 <- predict(rf, testing)
confusionMatrix(p10, testing$AttritionN)
```



RF Plots
========================================
Row
--------------------------------
### **Variable Importance - Top 10 **
```{r}
# Variable Importance
varImpPlot(rf,
           sort = T,
           n.var = 10,
           main = "Top 10 - Variable Importance")
#importance(rf)

```

### **Partial Dependence **
```{r}
# Partial Dependence Plot
partialPlot(rf, training, OverTimeN, "1")
```

### **Multi-dim Scaling Plot of Proximity**
```{r}
# Multi-dimensional Scaling Plot of Proximity Matrix
MDSplot(rf, training$AttritionN)

```

Row
---------------------------------------------
### **Single Tree **
```{r}
# Extract Single Tree
getTree(rf, 1, labelVar = TRUE)
```


### **Tune Mtry **
```{r}
# Tune mtry
t <- tuneRF(training[,-31], training[,31],
       stepFactor = 0.5,
       plot = TRUE,
       ntreeTry = 300,
       trace = FALSE,
       improve = 0.05)
```

Summary
========================================
<div align='center', padding: 50px>
<br>
<h1 style="font-size:50px;"><b>Key Insights</b></h1>
<hr>
<br>Company Demographics
<br> <ul>Females = 40%</ul>
<br> <ul>Males = 60%</ul>
<br> <ul>Females = 40%</ul>
<br> <ul>Males = 60%</ul>
<br>
<br>Over Time is a major contributor of attrition
<br>
  <h1>Project By:</h1>
  <br><h2>Heindel Adu, Stephen Johnson, Ross Fu, Anthony Yeung </h2> </br>
  <h3>Classification: <br> <b> CONFIDENTIAL REPORT! </b><br></h3>
</div>



